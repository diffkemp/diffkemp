name: CI

on: [push, pull_request]

env:
  KERNELS: >
    3.10.0-514.el7
    3.10.0-693.el7
    3.10.0-862.el7
    3.10.0-957.el7
    4.18.0-80.el8
    4.18.0-147.el8
    4.18.0-193.el8
    4.18.0-240.el8
    3.10
    4.11

jobs:
  cache-kernels:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@v10
      - uses: DeterminateSystems/magic-nix-cache-action@v4

      - name: Cache Linux Kernels
        id: kernel-cache
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/kernel
          key: kernels-${{ env.KERNELS }}
          lookup-only: true

      - name: Delete unused software
        if: steps.kernel-cache.outputs.cache-hit != 'true'
        # This is necessary for running CScope database build as it takes
        # a lot of disk space and the runners die silently when out of space.
        run: |
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL

      - name: Get Linux Kernels
        if: steps.kernel-cache.outputs.cache-hit != 'true'
        working-directory: ${{ github.workspace }}
        run: |
          mkdir kernel
          for k in $KERNELS; do
            nix develop .#test-kernel-buildenv --command bash -c \
              "rhel-kernel-get $k --output-dir kernel && \
               make -C kernel/linux-$k cscope"
          done

  build-and-test:
    needs: cache-kernels
    runs-on: ubuntu-latest
    strategy:
      matrix:
        llvm: [9, 10, 11, 12, 13, 14, 15, 16, 17]
        env:
          - CC: gcc-9
            CXX: g++-9
        asan: [OFF]
        regression-tests: [true]

        include:
          - llvm: 17
            env:
              CC: clang
              CXX: clang++
            asan: OFF
            regression-tests: true

          - llvm: 14
            env:
              CC: gcc-9
              CXX: g++-9
            asan: ON
            regression-tests: false

    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@v10
      - uses: DeterminateSystems/magic-nix-cache-action@v4

      - name: Delete unused software
        # This is necessary for running CScope database build as it takes
        # a lot of disk space and the runners die silently when out of space.
        run: |
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL

      - name: Restore Kernels
        uses: actions/cache/restore@v4
        if: matrix.regression-tests
        with:
          path: ${{ github.workspace }}/kernel
          key: kernels-${{ env.KERNELS }}
          fail-on-cache-miss: true

      - name: Prepare Build Environment
        run: |
          mkdir -p ${{ github.workspace }}/build

      - name: Configure and Build
        env: ${{ matrix.env }}
        run: >
          nix develop .#diffkemp-llvm${{ matrix.llvm }} --command bash -c
          "cmake -B build ${{ github.workspace }} -GNinja -DSANITIZE_ADDRESS=${{ matrix.asan }} &&
           ninja -C build"

      - name: Run SimpLL Unit Tests
        run: >
          nix develop .#diffkemp-llvm${{ matrix.llvm }} --command
          ninja test -C build

      - name: Run Tests
        if: matrix.regression-tests
        shell: bash
        run: >
          nix develop .#diffkemp-llvm${{ matrix.llvm }} --command bash -c
          "setuptoolsShellHook &&
           pytest tests -v"
